tinymce.PluginManager.add('codesource', function(editor, url){
	function showDialog(){
		var win, dom = editor.dom, selection = editor.selection, data = {}, Elmt, data_language;
		var defaultLanguage = 'html', defaultClass = 'hljs ', selected = false, selectionNode = selection.getNode();
		var keyPressed = null, timesPressed = 0, tabString = '', lastKeyPressed = null;

		data.language 	= '';

		var languageItems = [
			{text: 'Langage',		value: ''},
			{text: 'Apache', 		value: 'apache'},
			{text: 'Bash/Shell',	value: 'bash'},
			{text: 'CSS',			value: 'css'},
			{text: 'HTML',			value: 'html'},
			{text: 'Javascript', 	value: 'javascript'},
			{text: 'Nginx', 		value: 'nginx'},
			{text: 'PHP', 			value: 'php'},
			{text: 'SQL', 			value: 'sql'},
			{text: 'XML', 			value: 'xml'}
		];

		if(selectionNode.nodeName.toLowerCase() == 'pre' && selectionNode.className.indexOf(defaultClass) != -1){
			selected = true;
			selectedCode = $(selectionNode).html();
			selectedCode = selectedCode.replace(/\&lt\;/gi,"<").replace(/\&gt\;/gi,">");

			data_language = selectionNode.getAttribute('data-language');
			data.language = data_language;
		}else{
			selectedCode = selection.getContent({format: 'text'});
		}

		for(var i=0; i<languageItems.length; i++){
			if(languageItems[i].value == data.language){
				languageItems[i].selected = true;
			}
		}

		data.code = selectedCode;
		if(data.code == '&nbsp;')
			data.code = '';

		function onSubmitFunction(e){
			var code = e.data.code;
			var language = e.data.language ? e.data.language : defaultLanguage;

			Elmt = editor.dom.create('pre', {
				class: defaultClass + language,
				'data-language' : language
			}, code);

			if(selected){
				editor.dom.replace(Elmt, selectionNode);
			}else{
				editor.insertContent(editor.dom.getOuterHTML(Elmt)+'<br>');
			}
		}

		function onKeypressFunction(e) {
		    var elem = e.srcElement, start, end;
            var keyCode = e.keyCode || e.which;
            start = elem.selectionStart;
            end = elem.selectionEnd;
            if (keyCode === 9) {
                elem.value =  elem.value.substring(0, start) + "\t" + elem.value.substring(end) ;
                elem.selectionStart = elem.selectionEnd = start +1;
                keyPressed = keyCode;
                timesPressed = timesPressed + 1;
                return false;
            } else if (keyCode === 13 && keyPressed === 9) {
                tabString += "\t";
                elem.value = elem.value.substring(0, start) + "\r" + tabString + elem.value.substring(end) ;
                elem.selectionStart = elem.selectionEnd = start + timesPressed + 1;
                lastKeyPressed = keyCode;
                return false;
            } else if (keyCode === 8 && lastKeyPressed === 13 ) {
                keyPressed = null;
                timesPressed = 0;
                tabString = '';
            }
        }

		win = editor.windowManager.open({
			title: 'Editeur de code',
			data: data,
			minWidth: 550,
			body: [
				{name: 'language', type: 'listbox', values: languageItems},
				{name: 'code', type: 'textbox', minHeight:250, multiline: true}
			],
			onsubmit: onSubmitFunction,
            onkeydown: onKeypressFunction,
		});


	}

	editor.addButton('codesource', {
		tooltip: 'Ins√©rer / Editer du code',
		icon: 'code',
		onclick: showDialog
	});


});
